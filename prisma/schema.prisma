generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* === جديد: نوع الخصم للإعلانات والطلبات === */
enum DiscountType {
  PERCENT   // نسبة مئوية
  FLAT      // مبلغ ثابت (هللات)
}

enum SubscriptionTier {
  basic
  pro
  premium
}

model User {
  id           Int     @id @default(autoincrement())
  name         String
  email        String  @unique
  passwordHash String
  isSubscribed Boolean @default(false)
  role         String  @default("user")
  
  subscriptionTier SubscriptionTier @default(basic)
  // علاقات
  orders       Order[]
  resetTokens  PasswordResetToken[]

  // الحقول الجديدة
  weight        Int?
  height        Int?
  age           Int?
  gender        String?
  activityLevel String?
  goal          String?
  startWeight   Float?
  targetWeight  Float?
  startDate     DateTime?

  weightLogs    WeightLog[]

  // الخطة المحسوبة
  plan Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Announcement {
  id        Int       @id @default(autoincrement())
  title     String
  body      String
  isActive  Boolean   @default(true)
  startsAt  DateTime  @default(now())
  endsAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // خصم (اختياري)
  discountType  DiscountType?
  discountValue Int? @default(0)  // لو PERCENT = نسبة%، لو FLAT = هللات
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Order {
  id           Int           @id @default(autoincrement())
  invoiceId    String        @unique            // رقم/معرّف الفاتورة من ميسر
  userId       Int?
  user         User?         @relation(fields: [userId], references: [id])

  amount       Int                               // قبل الخصم (هللات)
  finalAmount  Int?                              // بعد الخصم (هللات)
  currency     String        @default("SAR")
  status       String        @default("pending") // pending | paid | failed | refunded
  gateway      String        @default("moyasar")

  // أثر الخصم وقت الطلب (اختياري)
  discountType  DiscountType?
  discountValue Int? @default(0)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}
model WeightLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  date      DateTime @default(now())
  weight    Float

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, date])
}
