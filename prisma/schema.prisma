generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * === جديد: نوع الخصم للإعلانات والطلبات ===
 */
enum DiscountType {
  PERCENT // نسبة مئوية
  FLAT // مبلغ ثابت (هللات)
}

enum SubscriptionTier {
  basic
  pro
  premium
}

model User {
  id           Int     @id @default(autoincrement())
  name         String
  email        String  @unique
  passwordHash String
  isSubscribed Boolean @default(false)
  role         String  @default("user")

  subscriptionTier  SubscriptionTier @default(basic)
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?

  // علاقات
  orders      Order[]
  resetTokens PasswordResetToken[]

  // الحقول الجديدة
  weight        Int?
  height        Int?
  age           Int?
  gender        String?
  activityLevel String?
  goal          String?
  startWeight   Float?
  targetWeight  Float?
  startDate     DateTime?

  weightLogs WeightLog[]
  
    foodDays   FoodDay[]
  // الخطة المحسوبة
  plan Json?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  wellness  Wellness[] // ← علاقة المستخدم مع سجلات الرفاهية
}

model Announcement {
  id        Int       @id @default(autoincrement())
  title     String
  body      String
  isActive  Boolean   @default(true)
  startsAt  DateTime  @default(now())
  endsAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // خصم (اختياري)
  discountType  DiscountType?
  discountValue Int?          @default(0) // لو PERCENT = نسبة%، لو FLAT = هللات
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Order {
  id        Int    @id @default(autoincrement())
  invoiceId String @unique // رقم/معرّف الفاتورة من ميسر
  userId    Int?
  user      User?  @relation(fields: [userId], references: [id])

  amount      Int // قبل الخصم (هللات)
  finalAmount Int? // بعد الخصم (هللات)
  currency    String @default("SAR")
  status      String @default("pending") // pending | paid | failed | refunded
  gateway     String @default("moyasar")

  // أثر الخصم وقت الطلب (اختياري)
  discountType  DiscountType?
  discountValue Int?          @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WeightLog {
  id     Int      @id @default(autoincrement())
  userId Int
  date   DateTime @default(now())
  weight Float

  user User @relation(fields: [userId], references: [id])

  @@index([userId, date])
}

model Wellness {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int

  date  DateTime @default(now()) // تاريخ اليوم
  water Int      @default(0) // عدد أكواب الماء
  sleep Int      @default(0) // ساعات النوم
  steps Int      @default(0) // عدد الخطوات

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date]) // سطر مهم: يمنع تكرار سجل لنفس اليوم
}
model FoodDay {
  id        Int       @id @default(autoincrement())
  userId    Int
  dayNumber Int        // (1–7)
  date      DateTime   // التاريخ الفعلي لليوم
  meals     FoodMeal[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  User      User       @relation(fields: [userId], references: [id])
}

model FoodMeal {
  id        Int          @id @default(autoincrement())
  foodDayId Int
  index     Int          // 1 أو 2 أو 3 أو 4

  items     FoodMealItem[]

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  FoodDay   FoodDay       @relation(fields: [foodDayId], references: [id])
}
model FoodMealItem {
  id        Int     @id @default(autoincrement())
  mealId    Int

  type      String  // "protein" | "carb" | "fat"
  foodKey   String  // مثلاً chicken_breast
  foodName  String  // الاسم العربي الظاهر للمستخدم
  amount    String  // مثل "120 جم" أو "2 حبة"

  kcals     Int
  protein   Int
  carbs     Int
  fat       Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  FoodMeal  FoodMeal @relation(fields: [mealId], references: [id])
}